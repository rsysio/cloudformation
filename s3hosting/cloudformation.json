{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Hosting static files in S3 with Cloudfront",

  "Parameters" : {

    "RootDomain" : {
      "Type" : "String",
      "Description" : "Domain name for your website (example.com)"
    },

    "DomainName" : {
      "Type" : "String",
      "Description" : "Enter the host name (www.example.com)"
    }

  },

  "Resources" : {

    "SSLCertificate" : {
      "Type" : "AWS::CertificateManager::Certificate",
      "Properties" : {
        "DomainName" : { "Ref" : "DomainName" },
        "DomainValidationOptions" : [
          {
            "DomainName" : { "Ref" : "DomainName" },
            "ValidationDomain" : { "Ref" : "RootDomain" }
          }
        ]
      }
    },

    "S3Bucket" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "AccessControl" : "PublicRead",
        "WebsiteConfiguration" : {
          "ErrorDocument" : "error.html",
          "IndexDocument" : "index.html"
        }
      }
    },

    "S3BucketPolicy" : {
      "Type" : "AWS::S3::BucketPolicy",
      "Properties" : {
        "Bucket" : {"Ref" : "S3Bucket"},
        "PolicyDocument": {
          "Statement":[{
          "Action":["s3:GetObject"],
          "Effect":"Allow",
          "Resource": { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "S3Bucket" } , "/*" ]]},
          "Principal":"*",
            "Condition":{
              "StringLike":{
                "aws:Referer":[
                  "https://www.rsys.io/*"
                ]
              }
            }
          }]
        }
      }
    },

    "CloudfrontDistribution" : {
      "Type" : "AWS::CloudFront::Distribution",
      "Properties" : {

        "DistributionConfig" : {

        "DefaultCacheBehavior" : {
          "ForwardedValues" : { "QueryString" : false },
          "TargetOriginId" : { "Fn::GetAtt" : [ "S3Bucket", "DomainName" ] },
          "ViewerProtocolPolicy" : "redirect-to-https"
      },
        "DefaultRootObject" : "index.html",
        "Enabled" : true,
        "HttpVersion" : "http2",

        "Origins" : [
          {
            "DomainName" : { "Fn::GetAtt" : [ "S3Bucket", "DomainName" ] },
            "Id" : { "Fn::GetAtt" : [ "S3Bucket", "DomainName" ] },
            "S3OriginConfig" : { "OriginAccessIdentity" : "" }
          }
        ],

        "PriceClass" : "PriceClass_200",
        "ViewerCertificate" :
          {
            "AcmCertificateArn" : { "Ref" : "SSLCertificate" },
            "SslSupportMethod" : "sni-only"
          }
        }
      }
    }
  },

  "Outputs" : {
    "DistributionEndpoint" : {
      "Description" : "CloudFront Distribution DomainName",
      "Value" : { "Fn::GetAtt" : [ "CloudfrontDistribution", "DomainName" ] },
      "Export" : {
        "Name" : { "Fn::Join" : [ ":", [ { "Ref" : "AWS::StackName" }, "AccountVPC" ] ] }
      }
    }
  }
}

